<!doctype html>
<html>
<head>
  <meta charset = "utf-8">
  <title>Birth Trends</title>
  <meta name="description" content="Birth Trends">
  <meta name="author" content="Amber Thomas">

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="birthTrends.css">

</head>

<body>


<div id = "container">

  <div id = "dropdowns">

    <!--Eventual State Dropdown-->
    <div id = "dropdown-a">
      <p class = "dd-title state">State</p>
        <div id = "states", class = "dd">
          <div class="select__arrow long"></div>
        </div>
    </div><!--


   --><div id = "dropdown-b">
      <p class = "dd-title county">County</p>
        <div id = "counties", class = "dd">
          <div class="select__arrow long"></div>
        </div>
    </div><!--


   --><div id = "dropdown-c">
      <p class = "dd-title year">Year</p>
        <div id = "year", class = "dd">
          <div class="select__arrow short"></div>
        </div>
    </div>

  </div>


<!--Adding event icons-->
<div id="icons">
    <p class = "dd-title events">Events</p>
    <div id="icon-a">
      <svg width="36" height="36" viewBox="0 0 36 36">
        <g id="icon-storms">
          <path d="M12.5,22C6.8,24.3,4,19.8,4,17c0-2.8,2.3-5.1,5.1-5.1c0.4,0,0.7,0,1,0.1c0-0.1,0-0.2,0-0.3
            c0-4.2,3.4-7.6,7.6-7.6c3.3,0,6.1,2.1,7.2,5C25.3,9.1,25.6,9,26,9c3.3,0,5.9,2.7,5.9,5.9c0,3.3-3.2,8.3-9.3,5.9"/>
          <polygon points="19,15.9 15.2,23.8 19,23.9 17.1,31.9 20.7,22 17.3,22.4"/>
        </g>
      </svg>
    </div><!--

   --><div id="icon-b">
        <svg width="36" height="36" viewBox="0 0 36 36">
          <g id="icon-sports">
              <path d="M29.9,6c2.4,2.4,1.7,12.8-4.7,19.2c-6.3,6.4-16.7,7.3-19.1,4.9c-2.4-2.4-1.8-12.6,4.7-19.2
                C17.3,4.3,27.5,3.6,29.9,6z"/>
              <line x1="5.5" y1="20.4" x2="15.8" y2="30.5"/>
              <line x1="20.3" y1="5.4" x2="30.6" y2="15.5"/>
              <line x1="14.4" y1="21.6" x2="22.2" y2="13.7"/>
              <line x1="14.4" y1="18.7" x2="17.6" y2="21.9"/>
              <line x1="16.9" y1="16.2" x2="20.1" y2="19.4"/>
              <line x1="19.5" y1="13.6" x2="22.7" y2="16.8"/>
          </g>
        </svg>
    </div><!--

   --><div id="icon-c">
        <svg width="36" height="36" viewBox="0 0 36 36">
          <g id="icon-terrorism">
            <polyline points="1.9,31.8 5.9,28.9 0,24.6 7.8,22.9 5.8,12.7 13.2,16.8 19.5,4.2 21.5,18 26.9,14.8 26.9,21.4 
              36,22.4 28.6,28.5 30.6,31.8"/>
            <polyline points="10.4,31.8 12.4,29.8 10.4,26.1 12.4,26.1 11.4,21.2 16.1,23.1 18,18 18.7,24.9 22.3,22.9 22.3,26.1 
              24.5,26.3 22.6,28.5 25.6,31.8"/>
          </g>
        </svg>
    </div>

    <div id="icon-dropdown">
    </div>

  </div>



  <script src="https://d3js.org/d3.v4.js"></script>
  <!--<script src="birthTrends1.js"></script>-->
  <div id = "graph">
  <script>


      //////////////////////////////////////////////////////////////////////
      /////////////////////////  GLOBAL VARIABLES  /////////////////////////
      //////////////////////////////////////////////////////////////////////

      // App holder for keeping global scope clean
      DS = {}

      // set the dimensions and margins of the graph
      var margin = {top: 20, right: 20, bottom: 30, left: 50},
        width = 1280 - margin.left - margin.right,
        height = 640 - margin.top - margin.bottom;

      // parse the date / time
      var parseTime = d3.timeParse("%y%m");
      var parseYear = d3.timeFormat("%Y"),
        parseMonth = d3.timeFormat("%b");
      var parseTimeMonth = d3.timeParse("%b");


      // set the ranges
      var x = d3.scaleTime().domain([parseTimeMonth("jan"),parseTimeMonth("dec")]).range([0, width]);
      var y = d3.scaleLinear().range([height, 0]);

      /*// Define the axes
      var xAxis = d3.axisBottom()
          .scale(x)
      var yAxis = d3.axisLeft(y)*/

      // define the line
      var valueLine = d3.line()
          .x(function(d) { return x(parseTimeMonth(d.month)); })
          .y(function(d) { return y(+d.Births); })
          ;

      // append the svg object to the body of the page
      // appends a 'group' element to 'svg'
      // moves the 'group' element to the top left margin
      var svg = d3.select("#graph").append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
        .append("g")
          .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")")
          .attr("class", "svg");





      //////////////////////////////////////////////////////////////////////
      ////////////////////////////  RESPONSIVE  ////////////////////////////
      //////////////////////////////////////////////////////////////////////  

    // make chart responsive
    d3.select("#graph")
        .append("div")
        .classed("svg-container", true) //container class to make it responsive
        .append("svg")

      //responsive SVG needs these 2 attributes and no width and height attr
        .attr("preserveAspectRatio", "xMinYMin meet")
        .attr("viewBox", function(d){
          "0 0 1280 640";
        })

      //class to make it responsive
        .classed("svg-content-responsive", true); 




      //////////////////////////////////////////////////////////////////////
      ////////////////////////////  DATA IMPORT ////////////////////////////
      //////////////////////////////////////////////////////////////////////

      // Get the data
      d3.csv("CondensedBirth3.csv", function(error, data) {
          if (error) throw error;
          // format the data
          data.forEach(function(d) {
              d.Date = parseTime(d.Date);
              d.month = parseMonth(d.Date);
              d.year = parseYear(d.Date);
              d.Births = +d.Births * 10;
              d.County = d.County;
          });


          // Nest the data to create a line for each county and each year
          var nested = d3.nest()
              .key(function(d) { return d.County; })
              .rollup(function(leaves){
                var extent = d3.extent(leaves, function(d){
                  return d.Births
                })
                var nest = d3.nest().key(function(d){
                  return d.year
                })
                .entries(leaves);
                return {extent:extent, years:nest};
              })
              .entries(data);

          // Nest data by year
          var nested2 = d3.nest()
              .key(function(d){ return d.year; })
              .entries(data);

              console.log(nested)

          var makeInitGraph = function(data){

          var LA = nested.filter(function(d){
            return +d.key == "6037";
          })

          // Draw initial view (LA County)
          // For lazy loading
          var LACounty = svg.selectAll("g")
                  .data(LA, function(d){
                    return d ? d.key : this.key;
                  })
                  .enter()
                  .append("g")
                  .attr("class", "counties")
                  .each(function(d){
                    y.domain(d.value.extent)
                  })
                  .selectAll("path")
                  .data(function(d) {
                    return (d.value.years);
                  })
                  .enter()
                  .append("path")
                  .attr("d",function(d){
                    return valueLine(d.values);
                  })
                  .attr("class", "line");

            var initialLine = svg.selectAll(".line")
                .filter(function(d){
                  return +d.key === 2015;
                })
                .classed("selected", true)
            };

            makeInitGraph();


            var xaxis = svg.append("g")
                   .attr("transform", "translate(0," + height + ")")
                   .attr("class", "x axis")
                   .call(d3.axisBottom(x)
                      .ticks(d3.timeMonth)
                      .tickSize(0, 0)
                      .tickFormat(d3.timeFormat("%b"))
                      .tickSizeInner(0)
                      .tickPadding(10));

              // Add the Y Axis
               var yaxis = svg.append("g")
                   .attr("class", "y axis")
                   .call(d3.axisLeft(y)
                      .ticks(5)
                      .tickSizeInner(0)
                      .tickPadding(6)
                      .tickSize(0, 0));

              

          // Create dropdown 1
          var list = d3.select("#counties")
          list.append("select").selectAll("option")
              .data(nested)
              .enter().append("option")
              .attr("value", function(d){
                  return d.key;
              })
              .text(function(d){
                  return d.key;
              })
              .property("selected", function(d){ return d.key === "6037"; })



          // Create line based on selection from dropdown 1
          list.on('change', function(){
              
              // Detecting whether a single year has already been selected
              var blueLine = d3.selectAll(".selected")
                  .data()

              var blueLineY = blueLine[0].key


              var selected = d3.select(this)
                  .select("select")
                  .property("value")

              // Filter data to only include selected county
              var selectCounty = nested.filter(function(d){
                return +d.key === +selected;
              });

              console.log(selectCounty)

              // Group the county-level data
             var Counties = svg.selectAll(".counties")
                  .data(selectCounty, function(d){
                    return d ? d.key : this.key;
                  });

              Counties.exit().remove();

              var CountiesEnter = Counties.enter()
                  .append("g")
                  .attr("class", "counties")
                  .each(function(d){
                    y.domain(d.value.extent)
                  });

                  console.log(CountiesEnter)


              var Paths = CountiesEnter.selectAll("path")
                  .data(function(d) {
                    return (d.value.years);
                  })


              var PathsEnter = Paths.enter()
                  .append("path")
                  .attr("class", "line")
                  .transition()
                      .duration(5000)
                      .attr("d",function(d){
                          return valueLine(d.values);
                      });

              var selLineU = svg.selectAll(".line")
                  .filter(function(d) {
                    return +d.key === +blueLineY
                  })
                  .classed("selected", true)

                      console.log(selLineU)

               Counties = CountiesEnter
                  .merge(Counties);


                // Update Y Axis
                d3.select(".y")
                  .transition()
                  .duration(750)
                  .call(d3.axisLeft(y)
                      .ticks(5)
                      .tickSizeInner(0)
                      .tickPadding(6)
                      .tickSize(0, 0));
          });

         

          // Create dropdown 2 (year)
          var yList = d3.select("#year")
          yList.append("select").selectAll("option")
              .data(nested2)
              .enter().append("option")
              .attr("value", function(d){
                return d.key;
              })    
              .text(function(d){
                return d.key;
              })
              .property("selected", function(d){ return d.key === "2015"; })


 

          // Select year (colored)
          yList.on('change', function(){
            var selectedYear = d3.select(this)
                .select("select")
                .property("value")

              console.log(selectedYear)
            // select all paths and select one that the year matches
            var selLine = svg.selectAll(".line")
              .classed("selected", false)
              .filter(function(d) {
                  return +d.key === +selectedYear
              })
              .classed("selected", true)


          })

      });
  </script>
</div>
</div>


</body>
</html>
