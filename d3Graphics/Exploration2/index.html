<!doctype html>
<html>
<head>
  <meta charset = "utf-8">
  <title>Birth Trends</title>
  <meta name="description" content="Birth Trends">
  <meta name="author" content="Amber Thomas">

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="birthTrends.css">

</head>

<body>

  <div id = "dropdowns">
    <div id = "countyleft">
      <p class = "dd-title county">County</p>
      <div id = "counties", class = "dd">
          <div class="select__arrow"></div>
      </div>

    </div>

    <div id = "yearright">
      <p class = "dd-title year">Year</p>
      <div id = "year", class = "dd">
          <div class="select__arrow"></div>
      </div>
    </div>
  </div>

  
  <script src="https://d3js.org/d3.v4.js"></script>
  <!--<script src="birthTrends1.js"></script>-->
  <div id = "chart">
  <script>


      //////////////////////////////////////////////////////////////////////
      /////////////////////////  GLOBAL VARIABLES  /////////////////////////
      //////////////////////////////////////////////////////////////////////

      // set the dimensions and margins of the graph
      var margin = {top: 20, right: 20, bottom: 30, left: 50},
        width = 960 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;

      // parse the date / time
      var parseTime = d3.timeParse("%y%m");
      var parseYear = d3.timeFormat("%Y"),
        parseMonth = d3.timeFormat("%b");
      var parseTimeMonth = d3.timeParse("%b");


      // set the ranges
      var x = d3.scaleTime().domain([parseTimeMonth("jan"),parseTimeMonth("dec")]).range([0, width]);
      var y = d3.scaleLinear().range([height, 0]);

      /*// Define the axes
      var xAxis = d3.axisBottom()
          .scale(x)
      var yAxis = d3.axisLeft(y)*/

      // define the line
      var valueLine = d3.line()
          .x(function(d) { return x(parseTimeMonth(d.month)); })
          .y(function(d) { return y(+d.Births); })
          ;

      // append the svg object to the body of the page
      // appends a 'group' element to 'svg'
      // moves the 'group' element to the top left margin
      var svg = d3.select("body").append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
        .append("g")
          .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")")
          .attr("class", "svg");


      //////////////////////////////////////////////////////////////////////
      ////////////////////////////  DATA IMPORT ////////////////////////////
      //////////////////////////////////////////////////////////////////////

      // Get the data
      d3.csv("CondensedBirth2.csv", function(error, data) {
          if (error) throw error;
          // format the data
          data.forEach(function(d) {
              d.Date = parseTime(d.Date);
              d.month = parseMonth(d.Date);
              d.year = parseYear(d.Date);
              d.Births = +d.Births * 10;
              d.County = d.County;
          });


          // Nest the data to create a line for each county and each year
          var nested = d3.nest()
              .key(function(d) { return d.County; })
              .rollup(function(leaves){
                var extent = d3.extent(leaves, function(d){
                  return d.Births
                })
                var nest = d3.nest().key(function(d){
                  return d.year
                })
                .entries(leaves);
                return {extent:extent, years:nest};
              })
              .entries(data);

          // Nest data by year
          var nested2 = d3.nest()
              .key(function(d){ return d.year; })
              .entries(data);

              console.log(nested)

          var LA = nested.filter(function(d){
            return +d.key == "6037";
          })

          // Draw initial view (LA County)
          // For lazy loading
          var LACounty = svg.selectAll("g")
                  .data(LA, function(d){
                    return d ? d.key : this.key;
                  })
                  .enter()
                  .append("g")
                  .attr("class", "counties")
                  .each(function(d){
                    y.domain(d.value.extent)
                  })
                  .selectAll("path")
                  .data(function(d) {
                    return (d.value.years);
                  })
                  .enter()
                  .append("path")
                  .attr("d",function(d){
                    return valueLine(d.values);
                  })
                  .attr("class", "line");

            var initialLine = svg.selectAll(".line")
                .filter(function(d){
                  return +d.key === 2015;
                })
                .classed("selected", true)


            var xaxis = svg.append("g")
                   .attr("transform", "translate(0," + height + ")")
                   .attr("class", "x axis")
                   .call(d3.axisBottom(x)
                      .ticks(d3.timeMonth)
                      .tickSize(0, 0)
                      .tickFormat(d3.timeFormat("%b"))
                      .tickSizeInner(0)
                      .tickPadding(10));

              // Add the Y Axis
               var yaxis = svg.append("g")
                   .attr("class", "y axis")
                   .call(d3.axisLeft(y)
                      .ticks(5)
                      .tickSizeInner(0)
                      .tickPadding(6)
                      .tickSize(0, 0));

              

          // Create dropdown 1
          var list = d3.select("#counties")
          list.append("select").selectAll("option")
              .data(nested)
              .enter().append("option")
              .attr("value", function(d){
                  return d.key;
              })
              .text(function(d){
                  return d.key;
              })
              .property("selected", function(d){ return d.key === "6037"; })



          // Create line based on selection from dropdown 1
          list.on('change', function(){
              
              // Detecting whether a single year has already been selected
              var blueLine = d3.selectAll(".selected")
                  .data()

              var blueLineY = blueLine[0].key


              var selected = d3.select(this)
                  .select("select")
                  .property("value")

              // Filter data to only include selected county
              var selectCounty = nested.filter(function(d){
                return +d.key === +selected;
              });

              console.log(selectCounty)

              // Group the county-level data
             var Counties = svg.selectAll(".counties")
                  .data(selectCounty, function(d){
                    return d ? d.key : this.key;
                  });

              Counties.exit().remove();

              var CountiesEnter = Counties.enter()
                  .append("g")
                  .attr("class", "counties")
                  .each(function(d){
                    y.domain(d.value.extent)
                  });

                  console.log(CountiesEnter)


              var Paths = CountiesEnter.selectAll("path")
                  .data(function(d) {
                    return (d.value.years);
                  })

                  // Attempts to classify path status by key
                  // for maintaining blue line later
                  /*.classed("selected", function(d){
                    return +d[key] > 1995 ? true : false;
                  })
              
              var PathsData = svg.select("path")

              console.log(Paths)
              console.log(Paths._enter)*/

              var PathsEnter = Paths.enter()
                  .append("path")
                  .attr("class", "line")
                  .transition()
                      .duration(5000)
                      .attr("d",function(d){
                          return valueLine(d.values);
                      });

                      console.log(PathsEnter)

               Counties = CountiesEnter
                  .merge(Counties);


                // Update Y Axis
                d3.select(".y")
                  .transition()
                  .duration(750)
                  .call(d3.axisLeft(y)
                      .ticks(5)
                      .tickSizeInner(0)
                      .tickPadding(6)
                      .tickSize(0, 0));
          });

         

          // Create dropdown 2 (year)
          var yList = d3.select("#year")
          yList.append("select").selectAll("option")
              .data(nested2)
              .enter().append("option")
              .attr("value", function(d){
                return d.key;
              })    
              .text(function(d){
                return d.key;
              })
              .property("selected", function(d){ return d.key === "2015"; })


 

          // Select year (colored)
          yList.on('change', function(){
            var selectedYear = d3.select(this)
                .select("select")
                .property("value")

              
            // select all paths and select one that the year matches
            var selLine = svg.selectAll(".line")
              .classed("selected", false)
              .filter(function(d) {
                  return +d.key === +selectedYear
              })
              .classed("selected", true)


          })

      });
  </script>
</div>


</body>
</html>
