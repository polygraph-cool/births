<!doctype html>
<html>
<head>
  <meta charset = "utf-8">
  <title>Birth Trends</title>
  <meta name="description" content="Birth Trends">
  <meta name="author" content="Amber Thomas">

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" type="text/css" href="https://cloud.typography.com/7124072/7681372/css/fonts.css">
  <link rel="stylesheet" href="birthTrends.css">

</head>

<body>

  <div id = "counties"></div>
  <div id = "year"></div>

  <script src="https://d3js.org/d3.v4.js"></script>
  <!--<script src="birthTrends1.js"></script>-->
  <script>


      //////////////////////////////////////////////////////////////////////
      /////////////////////////  GLOBAL VARIABLES  /////////////////////////
      //////////////////////////////////////////////////////////////////////

      // set the dimensions and margins of the graph
      var margin = {top: 20, right: 20, bottom: 30, left: 50},
        width = 960 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;

      // parse the date / time
      var parseTime = d3.timeParse("%y%m");
      var parseYear = d3.timeFormat("%Y"),
        parseMonth = d3.timeFormat("%b");
      var parseTimeMonth = d3.timeParse("%b");


      // set the ranges
      var x = d3.scaleTime().domain([parseTimeMonth("jan"),parseTimeMonth("dec")]).range([0, width]);
      var y = d3.scaleLinear().range([height, 0]);

      /*// Define the axes
      var xAxis = d3.axisBottom()
          .scale(x)
      var yAxis = d3.axisLeft(y)*/

      // define the line
      var valueLine = d3.line()
          .x(function(d) { return x(parseTimeMonth(d.month)); })
          .y(function(d) { return y(+d.Births); })
          ;

      // append the svg object to the body of the page
      // appends a 'group' element to 'svg'
      // moves the 'group' element to the top left margin
      var svg = d3.select("body").append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
        .append("g")
          .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");


      //////////////////////////////////////////////////////////////////////
      ////////////////////////////  DATA IMPORT ////////////////////////////
      //////////////////////////////////////////////////////////////////////

      // Get the data
      d3.csv("CondensedBirth2.csv", function(error, data) {
          if (error) throw error;
          // format the data
          data.forEach(function(d) {
              d.Date = parseTime(d.Date);
              d.month = parseMonth(d.Date);
              d.year = parseYear(d.Date);
              d.Births = +d.Births * 10;
              d.County = d.County;
          });

          // Nest the data to create a line for each county and each year
          var nested = d3.nest()
              .key(function(d) { return d.County; })
              .rollup(function(leaves){
                var extent = d3.extent(leaves, function(d){
                  return d.Births
                })
                var nest = d3.nest().key(function(d){
                  return d.year
                })
                .entries(leaves);
                return {extent:extent, years:nest};
              })
              .entries(data);

          // Nest data by year
          var nested2 = d3.nest()
              .key(function(d){ return d.year; })
              .entries(data);
              

          // Create dropdown 1
          var list = d3.select("#counties")
          list.append("select").selectAll("option")
              .data(nested)
              .enter().append("option")
              .attr("value", function(d){
                  return d.key;
              })
              .text(function(d){
                  return d.key;
              })

              console.log(list)

         /* // Create dropdown 2 (year)
          var yList = d3.select("#year")
          yList.append("select").selectAll("option")
              .data(nested2)
              .enter().append("option")
              .attr("value", function(d){
                return d.key;
              })    
              .text(function(d){
                return d.key;
              })
 

          // Select year (colored)
          yList.on('change', function(){
            var selectedYear = d3.select(this)
                .select("select")
                .property("value")
              
            // select all paths and select one that the year matches

          }) */


          // Create line based on selection from dropdown 1
          list.on('change', function(){
              var selected = d3.select(this)
                  .select("select")
                  .property("value")

              // Filter data to only include selected county
              var selectCounty = nested.filter(function(d){
                return +d.key === +selected;
              });

              console.log(selectCounty);

              svg.selectAll(".line").remove();



              // Group the county-level data
             var Counties = svg.selectAll("g")
                  .data(selectCounty, function(d){
                    return d ? d.key : this.key;
                  })
                  .enter()
                  .append("g")
                  .attr("class", "counties")
                  .each(function(d){
                    y.domain(d.value.extent)
                  })
                  .selectAll("path")
                  .data(function(d) {
                    return (d.value.years);
                  })
                  .enter()
                  .append("path")
                  .attr("d",function(d){
                    return valueLine(d.values);
                  })
                  .attr("class", "line");

      
                console.log(Counties)
             
               // Quick fix to destroy axes and re-draw
            svg.selectAll(".axis").remove();
             
              // Add the X Axis
               var xaxis = svg.append("g")
                   .attr("transform", "translate(0," + height + ")")
                   .attr("class", "axis")
                   //.call(xAxis)
                   .call(d3.axisBottom(x));
             //
            //   // Add the Y Axis
               var yaxis = svg.append("g")
                   .attr("class", "axis")
                   .call(d3.axisLeft(y));
          });

          // Create dropdown 2 (year)
          var yList = d3.select("#year")
          yList.append("select").selectAll("option")
              .data(nested2)
              .enter().append("option")
              .attr("value", function(d){
                return d.key;
              })    
              .text(function(d){
                return d.key;
              })
 

          // Select year (colored)
          yList.on('change', function(){
            var selectedYear = d3.select(this)
                .select("select")
                .property("value")

              
            // select all paths and select one that the year matches
            var selLine = svg.selectAll(".line")

            var element = d3.select(selLine.nodes()[0])
                .classed("selected", true)

              console.log(element)

          })

      });
  </script>



</body>
</html>
